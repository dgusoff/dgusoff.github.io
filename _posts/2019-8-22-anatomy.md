---
layout: post
title: SharePoint Online - Anatomy of a cloud-side catastrophe
---

The following account is a true story, and it happened today. The names of the victims have been changed to protect their innocence. The names of the perpetrators - well, they're Microsoft.

### Prologue - 11:30 PM

Two SharePoint administrators at Conglomo Corp are conducting a bulk file migration to a SharePoint Online site via ShareGate. It's a routine operation, and things are progressing smoothly, when suddenly the tool begins reporting a stream of errors. ShareGate hides the underlying error text but clearly the servers are barfing on the bytes. The admins conclude, reasonably, that they're being throttled. They shut down and call it a night.

### 8:30 AM

I arrive at the Rightpoint office, grab a diet Mountain dew, and start my day. I have one meeting, and project status, and those are usually pretty quick. It's going to be a good day. I have three things I need to do, and I block out sections of my Outlook calendar to time-box them.

### 9:00 AM

A Conglomo admin reaches out to me over Teams:

*"We have a bit of a problem. Nobody can upload documents."*

"That sounds like a problem. Can I reproduce this on a test site?"

*"Yep"*

I open my Chrome profile for Conglomo, navigate to a test site, and try to upload a file to a document library.

![alt text](/images/anatomy/error.png "Error Text")

Conglomo has thirty thousand site collections, and the vast majority are extranet sites shared with their clients. Conglomo's business revolves in substantial part around document collaboration. These are not cafeteria menus or marketing fluff that no one reads, these are business-critical applications, and every single one of them is broken. I have some work to do, but I have no idea at the moment what the resolution will look like.

### 9:05 AM 

The Outlook calendar is shot to hell.

### 9:06 AM

The investigation begins. These site collecitons are spawned from a remote site provisioning effort that began back in 2015. The sites in their current form were launched in 2016 and have been growing steadily in scale and functionality ever since. They've been remarkably stable - until today.

So what changed?

As far as we can tell, nothing.

I reach back out to the Conglomo administrator.

"Have you been moving around term sets? Renamed or swapped any site collections? Mass-updated master pages? Bulk-added event receivers to document libraries?

*"Nope. Nope. Nope. Nope."*

This has all the hallmarks of a platform issue. We will need to craft a support ticket for this one. But we can't do it just yet. Before Microsoft support will even look at a ticket, we need to provide a consise, easy-to-follow reproduction on a site that's free of any customizations. 

Our sites have a fair bit of customization: Custom Master Pages, Page Layouts, links to custom JS and CSS files, web parts, and custom fields and content types. We will need to reproduce our issue for support on a plain vanilla site or support will simply assume that the errors must be due to our customizations.

Our collaboration sites have four document libraries each, and it occurs to me to check if the error occurs on all of them or just a subset. We've already determined that "Documents" causes the error. In the next few minutes I determine that "Work in Progress" and "Status Reports" also cause the issue. But to my surprise, "Schedules" does not. Documents in that library upload just fine.

Our first clue.

### 9:40 AM

By this point we've determined that three of out four libraries are broken across the thoundands of sites, and a fourth library works as expected. But why? What's the difference?

I look at the error screen.

![alt text](/images/anatomy/error.png "Error Text")

Something about the URLs. I look at the libraries. Then again at the error message.

Spaces. "Schedules" does not have a space, and the others do (The URL for "Documents" is "Shared Documents").

On the test site I create a document library "I Have Spaces" and another called "NoSpaces" to test. I'm confident this will confirm my diagnosis but to my surprse it does not. Both libraries function perfectly.

What the hell is going on?

### 10:30 AM

The Conglomo admin reminds me that the three affected libraries share a content type, while the fourth does not have it.  OK, sure, but why would a content type have any effect on an "Invalid URL" error message?

Skeptical, I unhide the "Document" content type and set it as the default content type on a library. And damn it, it works.

This makes no sense, but there it is. A content type is causing the Invalid URL error.

I gaze at the list settings page, and the content type. For some reason my eyes linger over the two Taxonomy columns.  Taxonomy columns have always made me a little uneasy. There's just something unnatural, something *janky*, even for SharePoint. I re-add the content type as default, verify the issue is back, and then remove the two Taxonomy columns from the list content type. I try to upload a document, and it works.

Crepes almighty, we're onto something now.

### 10:45 AM

So, are *all* Taxonomy fields broken, or just one? Is the Service Application in a broken state or something? Everything seems in order on the admin page. I try to add a new Taxonomy column to the list and it still works. I try to add new columns on the same term sets and it they still work. So now I'm convinced the issue is not with the TermStore or specific Term Sets or Taxonomy columns in general. It has somehting to do with the specific site columns.

Eventually I narrow the issue down further to the specific site column. It's bound to a site collection-scoped Term Set called "Division". (There are valid reasons for a site collection scoped Term Set that I won't go into here.)  I notice that the site column has multiple values enabled, and that it has a default value.

After some trial and error I discover that on any of the 30,000 site collections, the issue is present if and only if the document library has in its default content type a Taxonomy field bound to this local Term Set, with multiple values enabled and a default value set.

Now we have solid reproduction instructions but I want to see if the issue persists across tenants. If we can prove this we'll have a more solid case to soliidify our support ticket.

I have a few Microsoft Demo tenants, and I try my theory against one of them. I'm dissappointed to find that I can't repro the issue there - everything works as it should. 

I decide to try one more tenant. I feel like a brand spanking new demo tenant might not be a good representation. I decide I need to test against a tenant with some miles on it. I dust off my old developer tenant that I've had since 2013 and try my theory.

And it throws the error. I can reproduce the issue across tenants.

It's time to flesh out the support ticket.

### 11:30 AM

Conglomo has already initiated the ticket, and I update it with the new repro steps:
1. Create a new document library
2. Create a new Taxonomy column bound to a local site-colleciton-scoped term set.
3. Make sure the Term Set has at least one term in it and set a term as the default value
4. Make sure Allow Multiple Values is enabled.
5. Try to upload a document. Observe the Invalid URL error

### 12:00 PM

Time for lunch and ping-pong. I runinate on the morning's events. These sites have been live for years, and one day out of the blue a core function just breaks without warning.

This is life in the cloud. You do the same thing over and over again, and you expect a different result. This can only mean one of two things: Insanity; or SharePoint.

### 1:00 PM

We've done all we can do on the support ticket On that front all we can do is wait. Based on prior experience it would be naive to expect any resolution before a couple days have gine by, if at all.  In the meantime we have critical functionality that's broken and needs to be fixed. We're going to have to run something - probably a PowerShell script - to get these sites back in business.

We decide to remove the default value from the Division site column on each of the 30,000 site collections. The data will not be appropriately tagged, but at this point untagged data is better than no data.

We generate a CSV of the existing site URLs and write a short script to loop through all the sites and set that site column's default value to an empty string. We test it out on a few sites and resign to run it after hours, where it will run for hours and hours. 


